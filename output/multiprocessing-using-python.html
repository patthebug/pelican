<!DOCTYPE html>
<html lang="en">
<head>

        <title>Multiprocessing using python</title>
        <meta charset="utf-8" />
        <link href="http://prateeksinghal.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="patthebug Full Atom Feed" />
        <link href="http://prateeksinghal.com/feeds/python.atom.xml" type="application/atom+xml" rel="alternate" title="patthebug Categories Atom Feed" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="http://prateeksinghal.com/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="http://prateeksinghal.com/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="http://prateeksinghal.com/theme/pygment.css" />

        <script src="http://prateeksinghal.com/theme/js/libs/modernizr-2.6.2.min.js"></script>






</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="http://prateeksinghal.com/">patthebug <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href="http://prateeksinghal.com/">Home</a></li>


              </ul>
            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="http://prateeksinghal.com/multiprocessing-using-python.html" rel="bookmark"
                   title="Permalink to Multiprocessing using python">Multiprocessing using python</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2014-05-27T10:20:00">
                Tue 27 May 2014
              </abbr>
              <address class="vcard author">
                By <a class="url fn" href="http://prateeksinghal.com/author/prateek-singhal.html">Prateek Singhal</a>
              </address>
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <h3>Simple Linear Regression using Python Multiprocessing library</h3>
<p>I recently learned executing "Simple Linear Regression" using <code>multiprocessing</code> module in python. This module is used for parallel processing in python. The <code>Î²</code> for Simple Linear Regression is calculated using the following formula:</p>
<p>$\beta  = \frac {\sum_{i=1}^{n} x_{i}y_{i} -  \frac {1}{n} \sum_{i=1}^{n} x_{i} \sum_{j=1}^{n} y_{j}} {\sum_{i=1}^{n} x_{i}^{2} - \frac {1}{n}(\sum_{i=1}^{n} x_{i})^2}$</p>
<p>I will use the <code>multiprocessing</code> and <code>numpy</code> modules for this task.</p>
<div class="highlight"><pre><span class="n">import</span> <span class="n">numpy</span> <span class="n">as</span> <span class="n">np</span>
<span class="n">import</span> <span class="n">multiprocessing</span> <span class="n">as</span> <span class="n">mp</span>
</pre></div>


<p>The dataset that I will be using for this task is freely downloadable from <a href="ftp://ftp.cdc.gov/pub/Health_Statistics/NCHS/nhanes/nhanes3/1A/adult.dat">here</a>.  </p>
<p>I will regress <code>age</code> against <code>weight</code>. The following function may be used to read the file in:</p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">map_func</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">:</span>
    <span class="n">age</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">17</span><span class="o">:</span><span class="mi">19</span><span class="p">])</span> <span class="err">#</span><span class="mi">18</span><span class="o">-</span><span class="mi">19</span>
    <span class="n">wtlbs</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1950</span><span class="o">:</span><span class="mi">1953</span><span class="p">])</span> <span class="err">#</span><span class="mi">1951</span><span class="o">-</span><span class="mi">1953</span> <span class="n">wt</span> <span class="n">in</span> <span class="n">lbs</span><span class="p">,</span> <span class="n">self</span> <span class="n">reported</span> <span class="o">!</span><span class="mi">888</span><span class="o">!</span> <span class="o">!</span><span class="mi">999</span><span class="o">!</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">age</span><span class="p">,</span> <span class="n">wtlbs</span><span class="p">]</span>
</pre></div>


<p>I am going to use this function to read the file in parallel using 3 processes at the same time. I am using a quad-core machine which is why I have left 1 process untouched, for recovery purposes just in case I happen to write an infinite loop.</p>
<p>For achieving this, I will use the <code>Pool</code> function and initiate 3 processes. After creating these processes, I will use the <code>map</code> function to distribute the reading job amongst the 3 processes. </p>
<div class="highlight"><pre><span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="n">adult</span><span class="p">.</span><span class="n">dat</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">map_func</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>


<p>The data has some observations in which the weight was unknown or not disclosed. Such observations have weight values of 888 and 999 and the following code will get rid of these observations.</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="n">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="n">zip</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="mi">888</span> <span class="n">or</span> <span class="n">item</span> <span class="o">==</span> <span class="mi">999</span><span class="o">:</span>
            <span class="n">m</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">zip</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">zip</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>The above code now leaves us with <code>age</code> and <code>weight</code> vectors in variables <code>x</code> and <code>y</code> respectively. Let us first up calculate the coefficients for simple linear regression using the conventional method (finding the least squares fit). </p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">ols_lls</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">:</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">x</span><span class="p">))]).</span><span class="n">T</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span>

<span class="n">m</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ols_lls</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="n">print</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span>
<span class="cp"># should print the values: (-0.0171020631488, 163.871290024)</span>
</pre></div>


<p>It may be a good idea now to verify these values with our own implementation of simple linear regression using the formula presented earlier.</p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">ols_sums</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">sum_x</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">sum_y</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">sum_xx</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
    <span class="n">sum_xy</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">sum_xy</span> <span class="o">-</span> <span class="n">sum_x</span><span class="o">*</span><span class="n">sum_y</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sum_xx</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">power</span><span class="p">(</span><span class="n">sum_x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">sum_y</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">sum_x</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span>

<span class="n">print</span> <span class="n">pool</span><span class="p">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ols_sums</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
<span class="cp"># should print the values: (-0.017102063148779986, 163.87129002440847)</span>
</pre></div>


<p>Notice that I have used two different functions <code>map</code> and <code>apply</code> available within the <code>multiprocessing</code> module. More about these methods can be learnt <a href="https://docs.python.org/dev/library/multiprocessing.html">here</a>.</p>
<p>Finally, one can easily notice that the values of parameters using the conventional <code>numpy</code> method and <code>multiprocessing</code> module are almost exactly the same.</p>
<p>Now for finally plotting the results, I will use <code>matplotlib</code>.</p>
<div class="highlight"><pre><span class="n">import</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">pyplot</span> <span class="n">as</span> <span class="n">plt</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="sc">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Original</span> <span class="n">data</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">m</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Fitted</span> <span class="n">line</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<p>The complete code may be found <a href="https://github.com/patthebug/MultiProcessing/blob/master/SimpleLinearRegression.py">here</a>.</p><script type= "text/javascript">
    if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
        var mathjaxscript = document.createElement('script');
        mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
        mathjaxscript.type = 'text/javascript';
        mathjaxscript.src = 'https:' == document.location.protocol
                ? 'https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'
                : 'http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
        mathjaxscript[(window.opera ? "innerHTML" : "text")] =
            "MathJax.Hub.Config({" +
            "    config: ['MMLorHTML.js']," +
            "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
            "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
            "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
            "    displayAlign: 'center'," +
            "    displayIndent: '0em'," +
            "    showMathMenu: true," +
            "    tex2jax: { " +
            "        inlineMath: [ ['$','$'] ], " +
            "        displayMath: [ ['$$','$$'] ]," +
            "        processEscapes: true," +
            "        preview: 'TeX'," +
            "    }, " +
            "    'HTML-CSS': { " +
            "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
            "    } " +
            "}); ";
        (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
    }
</script>

            </div><!-- /.entry-content -->


        </div><!-- /.eleven.columns -->
        
<div class="three columns">

<h4>Pages</h4>

 <ul>
  </ul>

<h4>Categories</h4>
<ul>
		<li><a href="http://prateeksinghal.com/category/python.html">Python</a></li>
</ul>


<h4>Tags</h4>
	<ul>
	    <li class="tag-4"><a href="http://prateeksinghal.com/tag/pelican.html">pelican</a></li>
	    <li class="tag-4"><a href="http://prateeksinghal.com/tag/multiprocessing.html">multiprocessing</a></li>
	    <li class="tag-4"><a href="http://prateeksinghal.com/tag/simplelinearregression.html">simplelinearregression</a></li>
	    <li class="tag-4"><a href="http://prateeksinghal.com/tag/python.html">python</a></li>
</ul>


<nav class="widget">
  <h4>Social</h4>
  <ul>
    <li><a href="#">You can add links in your config file</a></li>
    <li><a href="#">Another social link</a></li>
  </ul>
</nav>

</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">

                <li><div class="btn primary"><a href="https://github.com/patthebug" target="_blank">Github</a></div></li>


                <li><div class="btn facebook"><a href="https://www.facebook.com/prateek2686" target="_blank">Facebook</a></div></li>


              </ul>
            </div>
          </div>
        </footer>

    </div>


  <script src="http://prateeksinghal.com/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="http://prateeksinghal.com/theme/js/libs/gumby.min.js"></script>
  <script src="http://prateeksinghal.com/theme/js/plugins.js"></script>
</body>
</html>