<!DOCTYPE html>
<html lang="en">
<head>
        <title>patthebug - pelican</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://patthebug.github.io/pelican/theme/css/main.css" type="text/css" />
        <link href="http://patthebug.github.io/pelican/" type="application/atom+xml" rel="alternate" title="patthebug ATOM Feed" />


        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://patthebug.github.io/pelican/css/ie.css"/>
                <script src="http://patthebug.github.io/pelican/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://patthebug.github.io/pelican/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://patthebug.github.io/pelican/index.html">patthebug </a></h1>
                <nav><ul>
                <li><a href="http://patthebug.github.io/pelican/">Archives</a></li>
                </ul></nav>
        </header><!-- /#banner -->

     <section id="content" class="body">
        <aside id="featured"><article>
                <h1 class="entry-title"><a href="http://patthebug.github.io/pelican/multiprocessing-using-python.html">Multiprocessing using python</a></h1>
<footer class="post-info">
        <abbr class="published" title="2014-05-27T10:20:00">
                Tue 27 May 2014
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://patthebug.github.io/pelican/author/prateek-singhal.html">Prateek Singhal</a>
        </address>
<p>In <a href="http://patthebug.github.io/pelican/category/python.html">Python</a>. </p>
<p>tags: <a href="http://patthebug.github.io/pelican/tag/pelican.html">pelican</a><a href="http://patthebug.github.io/pelican/tag/publishing.html">publishing</a></p></p></footer><!-- /.post-info --><!-- /.post-info -->
                <h3>Simple Linear Regression using Python Multiprocessing library</h3>
<p>I recently learned executing "Simple Linear Regression" using <code>multiprocessing</code> module in python. This module is used for parallel processing in python. The <code>β</code> for Simple Linear Regression is calculated using the following formula:</p>
<p>$\beta  = \frac {\sum_{i=1}^{n} x_{i}y_{i} -  \frac {1}{n} \sum_{i=1}^{n} x_{i} \sum_{j=1}^{n} y_{j}} {\sum_{i=1}^{n} x_{i}^{2} - \frac {1}{n}(\sum_{i=1}^{n} x_{i})^2}$</p>
<p>I will use the <code>multiprocessing</code> and <code>numpy</code> modules for this task.</p>
<div class="highlight"><pre><span class="n">import</span> <span class="n">numpy</span> <span class="n">as</span> <span class="n">np</span>
<span class="n">import</span> <span class="n">multiprocessing</span> <span class="n">as</span> <span class="n">mp</span>
</pre></div>


<p>The dataset that I will be using for this task is freely downloadable from <a href="ftp://ftp.cdc.gov/pub/Health_Statistics/NCHS/nhanes/nhanes3/1A/adult.dat">here</a>.  </p>
<p>I will regress <code>age</code> against <code>weight</code>. The following function may be used to read the file in:</p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">map_func</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">:</span>
    <span class="n">age</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">17</span><span class="o">:</span><span class="mi">19</span><span class="p">])</span> <span class="err">#</span><span class="mi">18</span><span class="o">-</span><span class="mi">19</span>
    <span class="n">wtlbs</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1950</span><span class="o">:</span><span class="mi">1953</span><span class="p">])</span> <span class="err">#</span><span class="mi">1951</span><span class="o">-</span><span class="mi">1953</span> <span class="n">wt</span> <span class="n">in</span> <span class="n">lbs</span><span class="p">,</span> <span class="n">self</span> <span class="n">reported</span> <span class="o">!</span><span class="mi">888</span><span class="o">!</span> <span class="o">!</span><span class="mi">999</span><span class="o">!</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">age</span><span class="p">,</span> <span class="n">wtlbs</span><span class="p">]</span>
</pre></div>


<p>I am going to use this function to read the file in parallel using 3 processes at the same time. I am using a quad-core machine which is why I have left 1 process untouched, for recovery purposes just in case I happen to write an infinite loop.</p>
<p>For achieving this, I will use the <code>Pool</code> function and initiate 3 processes. After creating these processes, I will use the <code>map</code> function to distribute the reading job amongst the 3 processes. </p>
<div class="highlight"><pre><span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="n">adult</span><span class="p">.</span><span class="n">dat</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">map_func</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>


<p>The data has some observations in which the weight was unknown or not disclosed. Such observations have weight values of 888 and 999 and the following code will get rid of these observations.</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="n">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="n">zip</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="mi">888</span> <span class="n">or</span> <span class="n">item</span> <span class="o">==</span> <span class="mi">999</span><span class="o">:</span>
            <span class="n">m</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">zip</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">zip</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>The above code now leaves us with <code>age</code> and <code>weight</code> vectors in variables <code>x</code> and <code>y</code> respectively. Let us first up calculate the coefficients for simple linear regression using the conventional method (finding the least squares fit). </p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">ols_lls</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">:</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">x</span><span class="p">))]).</span><span class="n">T</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span>

<span class="n">m</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ols_lls</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="n">print</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span>
<span class="cp"># should print the values: (-0.0171020631488, 163.871290024)</span>
</pre></div>


<p>It may be a good idea now to verify these values with our own implementation of simple linear regression using the formula presented earlier.</p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">ols_sums</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">sum_x</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">sum_y</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">sum_xx</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
    <span class="n">sum_xy</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">sum_xy</span> <span class="o">-</span> <span class="n">sum_x</span><span class="o">*</span><span class="n">sum_y</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sum_xx</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">power</span><span class="p">(</span><span class="n">sum_x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">sum_y</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">sum_x</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span>

<span class="n">print</span> <span class="n">pool</span><span class="p">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ols_sums</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
<span class="cp"># should print the values: (-0.017102063148779986, 163.87129002440847)</span>
</pre></div>


<p>Notice that I have used two different functions <code>map</code> and <code>apply</code> available within the <code>multiprocessing</code> module. More about these methods can be learnt <a href="https://docs.python.org/dev/library/multiprocessing.html">here</a>.</p>
<p>Finally, one can easily notice that the values of parameters using the conventional <code>numpy</code> method and <code>multiprocessing</code> module are almost exactly the same.</p>
<p>Now for finally plotting the results, I will use <code>matplotlib</code>.</p>
<div class="highlight"><pre><span class="n">import</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">pyplot</span> <span class="n">as</span> <span class="n">plt</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="sc">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Original</span> <span class="n">data</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">m</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Fitted</span> <span class="n">line</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<p>The complete code may be found <a href="https://github.com/patthebug/MultiProcessing/blob/master/SimpleLinearRegression.py">here</a>.</p><script type= "text/javascript">
    if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
        var mathjaxscript = document.createElement('script');
        mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
        mathjaxscript.type = 'text/javascript';
        mathjaxscript.src = 'https:' == document.location.protocol
                ? 'https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'
                : 'http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
        mathjaxscript[(window.opera ? "innerHTML" : "text")] =
            "MathJax.Hub.Config({" +
            "    config: ['MMLorHTML.js']," +
            "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
            "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
            "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
            "    displayAlign: 'center'," +
            "    displayIndent: '0em'," +
            "    showMathMenu: true," +
            "    tex2jax: { " +
            "        inlineMath: [ ['$','$'] ], " +
            "        displayMath: [ ['$$','$$'] ]," +
            "        processEscapes: true," +
            "        preview: 'TeX'," +
            "    }, " +
            "    'HTML-CSS': { " +
            "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
            "    } " +
            "}); ";
        (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
    }
</script>

        </article></aside><!-- /#featured -->
</ol><!-- /#posts-list -->
</section><!-- /#content -->

        <aside id="sidebar">
                <div class="widget">
                        <h2>Categories</h2>
                        <ul>
                           <li ><a href="http://patthebug.github.io/pelican/category/python.html">Python</a></li>
                        </ul>
                </div>
                <div class="widget blogroll">
                        <h2>Blogroll</h2>
                        <ul>
                            <li><a href="http://www.mattobrien.me/">Matt O'Brien</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="widget social">
                        <h2>Social</h2>
                        <ul>
                            <li><a href="http://patthebug.github.io/pelican/feeds/all.atom.xml" rel="alternate">atom feed</a></li>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </aside><!-- /#sidebar -->

        <footer id="footer" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>, which takes great advantages of <a href="http://python.org">python</a>.
                </address><!-- /#about -->

                <p>The theme is «notmyidea-cms», a modified version of «notmyidea», the default theme.</p>
        </footer><!-- /#footer -->

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-51399126-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>